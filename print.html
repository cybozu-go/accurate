<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Accurate Documentation</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-f9ed5e27.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-b72d374f.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">Accurate Documentation</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/cybozu-go/accurate" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="accurate-documentation"><a class="header" href="#accurate-documentation">Accurate documentation</a></h1>
<p>Accurate is a Kubernetes controller for soft multi-tenancy environments.
It is currently developed and maintained by <a href="https://cybozu-global.com/">Cybozu</a>.</p>
<p>The repository is at <a href="https://github.com/cybozu-go/accurate">https://github.com/cybozu-go/accurate</a> .</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="overview"><a class="header" href="#overview">Overview</a></h1>
<p>Accurate is a Kubernetes controller to help operations in large soft multi-tenancy environments.</p>
<h2 id="soft-multi-tenancy-in-kubernetes"><a class="header" href="#soft-multi-tenancy-in-kubernetes">Soft multi-tenancy in Kubernetes</a></h2>
<p>Kubernetes does not provide multi-tenancy functions on its own.
It merely provides <a href="https://kubernetes.io/docs/concepts/overview/working-with-objects/namespaces/">Namespaces</a> along with <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/">Role-Based Access Control (RBAC)</a> to isolate resources such as Pods.</p>
<p><em>Soft multi-tenancy</em> is a kind of technique to implement Namespace-based multi-tenancy on Kubernetes.
On the other hand, <em>hard multi-tenancy</em> provides a virtual <code>kube-apiserver</code> for each tenant to isolate privileges completely.</p>
<p>In a soft multi-tenancy environment, a cluster admin grants privileges in a Namespace to a group of tenant users by creating RoleBinding object like this:</p>
<pre><code class="language-yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  namespace: tenant
  name: admin
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: admin
subjects:
- kind: Group
  name: group-for-tenant
  apiGroup: rbac.authorization.k8s.io
</code></pre>
<p><code>admin</code> ClusterRole is <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#user-facing-roles">a built-in role</a> to give admin privileges on any kind of namespace-scope resources.
With this RoleBinding, users in <code>group-for-tenant</code> can freely create/edit/delete namespace-scope resources in <code>tenant</code> Namespace.</p>
<p>In many cases, a tenant needs to have multiple Namespaces to run multiple independent applications.
However, tenant users are not allowed to create or delete Namespaces because Namespace is a cluster-scope resource.
Otherwise, they would be able to delete other tenants’ Namespaces!</p>
<h2 id="what-is-accurate"><a class="header" href="#what-is-accurate">What is Accurate?</a></h2>
<p>Accurate introduces a namespace-scope custom resource called <strong>SubNamespace</strong>.
With SubNamespace, tenant users can create a Namespace by creating a SubNamespace, and delete the created Namespace by deleting the SubNamespace.</p>
<p>The created Namespace is considered a child of the Namespace where the SubNamespace is created.
The child Namespace may inherit labels and annotations from its parent Namespace.</p>
<p>Accurate also propagates resources such as Role, RoleBinding, or Secret from a parent Namespace to its children Namespaces.
Without propagating Role/RoleBinding, the tenant user would be able to do nothing in newly created Namespaces.</p>
<h2 id="features"><a class="header" href="#features">Features</a></h2>
<ul>
<li>
<p>Resource propagation between namespaces</p>
<p>Accurate can propagate any namespace-scope resource including custom resources between Namespaces.</p>
</li>
<li>
<p>Inheriting labels and annotations creation/update from parent namespaces</p>
<p>Namespace labels often play important roles.
For example, <a href="https://kubernetes.io/docs/concepts/security/pod-security-admission/">Pod Security Admission</a> uses Namespace labels to control security policies.</p>
</li>
<li>
<p>SubNamespace custom resource for tenant users</p>
<p>This is the feature to allow tenant users to create and delete Namespaces by themselves.
SubNamespaces can be created in either a root Namespace or a Namespace created by SubNamespace.
A root Namespace is a Namespace labeled with <code>accurate.cybozu.com/type=root</code>.</p>
</li>
<li>
<p>Template namespaces</p>
<p>A template Namespace is a Namespace labeled with <code>accurate.cybozu.com/type=template</code>.
Labels, annotations, and resources can be propagated from a template Namespace to other Namespaces referencing the template with <code>accurate.cybozu.com/template=&lt;name&gt;</code> label.</p>
<p>This feature is implemented to allow resource propagation between normal Namespaces.</p>
</li>
<li>
<p><code>kubectl</code> plugin</p>
<p><code>kubectl-accurate</code> is a <code>kubectl</code> plugin to make the operations for Accurate easy.</p>
</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="concepts"><a class="header" href="#concepts">Concepts</a></h1>
<h2 id="namespace-types"><a class="header" href="#namespace-types">Namespace types</a></h2>
<p>Accurate defines the following types of Namespaces:</p>
<ul>
<li>Template: Namespace labeled with <code>accurate.cybozu.com/type=template</code></li>
<li>Root: Namespace labeled with <code>accurate.cybozu.com/type=root</code></li>
<li>Sub-namespace: Namespace labeled with <code>accurate.cybozu.com/parent=&lt;name&gt;</code></li>
</ul>
<p>Any Namespace other than sub-namespaces can reference a template Namespace with <code>accurate.cybozu.com/template=&lt;name&gt;</code> label.</p>
<p>Sub-namespace can reference a root or another sub-namespace as its parent.</p>
<p>When configured to do so, Accurate propagates the Namespace labels, annotations, and namespace-scope resources from a referenced Namespace to referencing Namespaces.</p>
<p>Circular references are prohibited by an admission webhook.</p>
<h2 id="resource-propagation"><a class="header" href="#resource-propagation">Resource propagation</a></h2>
<p>Accurate propagates any namespace-scope resource that are annotated with <code>accurate.cybozu.com/propagate=&lt;mode&gt;</code>.</p>
<p>Mode is one of the following:</p>
<ul>
<li><code>create</code>: the resource will be created in referencing Namespaces if missing.</li>
<li><code>update</code>: the resource will be created in referencing Namespaces if missing, or will be updated if not identical, or will be deleted when the resource in the referenced Namespace is deleted.</li>
</ul>
<h2 id="propagating-generated-resources-deprecated"><a class="header" href="#propagating-generated-resources-deprecated">Propagating generated resources (DEPRECATED)</a></h2>
<div class="warning">
Propagating generated resources is a deprecated feature and is subject for
removal soon.
</div>

<p>If a resource annotated with <code>accurate.cybozu.com/propagate-generated=&lt;mode&gt;</code> creates a resource and set an owner reference in the created resource, Accurate automatically adds <code>accurate.cybozu.com/propagate=&lt;mode&gt;</code> to the created resource.</p>
<p>This can be used, for example, to propagate Secret created from <a href="https://github.com/bitnami-labs/sealed-secrets">SealedSecret</a>.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="getting-started"><a class="header" href="#getting-started">Getting started</a></h1>
<p>Follow these steps to install Accurate on your cluster and start using it.</p>
<ol>
<li><a href="#configurations">Adjust configurations</a> for your environment</li>
<li><a href="#deploying-accurate">Install cert-manager and apply Accurate manifests</a></li>
<li><a href="#installing-kubectl-plugin">Install <code>kubectl-accurate</code> to local machines</a></li>
</ol>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="configurations"><a class="header" href="#configurations">Configurations</a></h1>
<h2 id="helm-chart-values"><a class="header" href="#helm-chart-values">Helm Chart values</a></h2>
<p>Read <a href="#accurate-helm-chart">Helm Chart</a> for details.</p>
<h2 id="configuration-file"><a class="header" href="#configuration-file">Configuration file</a></h2>
<p><a href="#accurate-controller"><code>accurate-controller</code></a> reads its configurations from a configuration file.</p>
<p>The repository includes an example as follows:</p>
<pre><code class="language-yaml"># Labels to be propagated to sub-namespaces.
# It is also possible to specify a glob pattern that can be interpreted by Go's "path.Match" func.
# https://pkg.go.dev/path#Match
labelKeys:
- team

# Annotations to be propagated to sub-namespaces.
# It is also possible to specify a glob pattern that can be interpreted by Go's "path.Match" func.
# https://pkg.go.dev/path#Match
annotationKeys:
# An example to propagate an annotation for MetalLB
# https://metallb.universe.tf/usage/#requesting-specific-ips
- metallb.universe.tf/address-pool

# Labels to be propagated to sub-namespaces from SubNamespace resource.
# It is also possible to specify a glob pattern that can be interpreted by Go's "path.Match" func.
# https://pkg.go.dev/path#Match
subNamespaceLabelKeys:
- app

# Annotations to be propagated to sub-namespaces from SubNamespace resource.
# It is also possible to specify a glob pattern that can be interpreted by Go's "path.Match" func.
# https://pkg.go.dev/path#Match
subNamespaceAnnotationKeys:
- foo.bar/baz

# List of GVK for namespace-scoped resources that can be propagated.
# Any namespace-scoped resource is allowed.
watches:
- group: rbac.authorization.k8s.io
  version: v1
  kind: Role
- group: rbac.authorization.k8s.io
  version: v1
  kind: RoleBinding
- version: v1
  kind: Secret
- version: v1
  kind: ResourceQuota

# List of nameing policy for SubNamespaces.
# root and match are both regular expressions.
# When a SubNamespace is created in a tree starting from a root namespace and the root namespace's name matches the "root" regular expression, the SubNamespace name is validated with the "match" regular expression.
#
# "match" namingPolicies can use variables of regexp capture group naming of "root" namingPolicies.
# example:
#   root: ^app-(?P&lt;team&gt;.*)
#   match: ^app-${team}-.*
#   root namespace: app-team1
#   compiled match naming policy: ^app-team1-.*
# This feature is provided using https://pkg.go.dev/regexp#Regexp.Expand
namingPolicies: []
</code></pre>
<p>Only labels and annotations specified in the configuration file will be inherited.<br>Be careful that some labels or annotations affect security configurations or the system.
For example, <a href="https://kubernetes.io/docs/concepts/security/pod-security-admission/#pod-security-admission-labels-for-namespaces"><code>pod-security.kubernetes.io/*</code></a> labels control the security capabilities of Pods in a Namespace.</p>
<p>Likewise, Accurate watches only namespace-scope resources specified in the configuration file.</p>
<p>You can edit the Helm Chart values as needed.</p>
<pre><code class="language-yaml">&lt;snip&gt;
controller:
  config:
    # controller.config.labelKeys -- Labels to be propagated to sub-namespaces.
    # It is also possible to specify a glob pattern that can be interpreted by Go's "path.Match" func.
    ## https://pkg.go.dev/path#Match
    labelKeys: []
    # - team

    # controller.config.annotationKeys -- Annotations to be propagated to sub-namespaces.
    # It is also possible to specify a glob pattern that can be interpreted by Go's "path.Match" func.
    ## https://pkg.go.dev/path#Match
    annotationKeys: []
    # An example to propagate an annotation for MetalLB
    # https://metallb.universe.tf/usage/#requesting-specific-ips
    # - metallb.universe.tf/address-pool

    # Labels to be propagated to sub-namespaces from SubNamespace resource.
    # It is also possible to specify a glob pattern that can be interpreted by Go's "path.Match" func.
    # https://pkg.go.dev/path#Match
    subNamespaceLabelKeys:
    - app

    # Annotations to be propagated to sub-namespaces from SubNamespace resource.
    # It is also possible to specify a glob pattern that can be interpreted by Go's "path.Match" func.
    # https://pkg.go.dev/path#Match
    subNamespaceAnnotationKeys:
    - foo.bar/baz

    # controller.config.watches -- List of GVK for namespace-scoped resources that can be propagated.
    # Any namespace-scoped resource is allowed.
    watches:
      - group: rbac.authorization.k8s.io
        version: v1
        kind: Role
      - group: rbac.authorization.k8s.io
        version: v1
        kind: RoleBinding
      - version: v1
        kind: Secret

    # controller.config.namingPolicies -- List of nameing policy for SubNamespaces.
    # root and match are both regular expressions.
    # When a SubNamespace is created in a tree starting from a root namespace and the root namespace's name matches the "root" regular expression, the SubNamespace name is validated with the "match" regular expression.
    #
    # "match" namingPolicies can use variables of regexp capture group naming of "root" namingPolicies.
    # example:
    #   root: ^app-(?P&lt;team&gt;.*)
    #   match: ^app-${team}-.*
    #   root namespace: app-team1
    #   compiled match naming policy: ^app-team1-.*
    # This feature is provided using https://pkg.go.dev/regexp#Regexp.Expand
    namingPolicies:
      - root:  foo
        match: foo_.*
      - root:  bar
        match: bar_.*
      - root:  ^app-(?P&lt;team&gt;.*)
        match: ^app-${team}-.*
&lt;snip&gt;
</code></pre>
<h2 id="clusterrolebindings"><a class="header" href="#clusterrolebindings">ClusterRoleBindings</a></h2>
<p>A built-in ClusterRole <code>admin</code> is bound by default to allow <code>accurate-controller</code> to watch and propagate namespace-scope resources. However, <code>admin</code> does not contain verbs for <a href="https://kubernetes.io/docs/concepts/policy/resource-quotas/">ResourceQuota</a> and may not contain custom resources.</p>
<p>If you need to watch and propagate resources not included in <code>admin</code> ClusterRole, add additional ClusterRole/ClusterRoleBinding to <code>accurate-controller-manager</code> ServiceAccount.
Set the <code>controller.additionalRBAC.rules</code> in the Helm Chart values.</p>
<p>The following example Helm chart values is to watch and propagate ResourceQuotas.</p>
<pre><code class="language-yaml">&lt;snip&gt;
controller:
  additionalRBAC:
    # controller.additionalRBAC.rules -- Specify the RBAC rules to be added to the controller.
    # ClusterRole and ClusterRoleBinding are created with the names `{{ release name }}-additional-resources`.
    # The rules defined here will be used for the ClusterRole rules.
    rules:
      - apiGroups:
          - ""
        resources:
          - resourcequotas
        verbs:
          - get
          - list
          - watch
          - create
          - patch
          - delete
&lt;snip&gt;
</code></pre>
<h2 id="feature-gates"><a class="header" href="#feature-gates">Feature Gates</a></h2>
<p>Feature gates are a set of key=value pairs that describe operator features.
You can turn these features on or off using the <code>--feature-gates</code> command line flag.
Use <code>-h</code> flag to see a full set of feature gates.</p>
<p>To set feature gates, use the <code>--feature-gates</code> flag assigned to a list of feature pairs:</p>
<pre><code class="language-shell">--feature-gates=...,DisablePropagateGenerated=false
</code></pre>
<p>The following table is a summary of the feature gates that you can set.</p>
<ul>
<li>The “Since” column contains the Accurate release when a feature is introduced
or its release stage is changed.</li>
<li>The “Until” column, if not empty, contains the last Accurate release in which
you can still use a feature gate.</li>
</ul>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Feature</th><th>Default</th><th>Stage</th><th>Since</th><th>Until</th></tr>
</thead>
<tbody>
<tr><td><code>DisablePropagateGenerated</code></td><td><code>false</code></td><td>Alpha</td><td>1.2.0</td><td>1.3.0</td></tr>
<tr><td><code>DisablePropagateGenerated</code></td><td><code>true</code></td><td>Beta</td><td>1.3.0</td><td></td></tr>
</tbody>
</table>
</div>
<p>Each feature gate is designed for enabling/disabling a specific feature:</p>
<ul>
<li><code>DisablePropagateGenerated</code>: Disable <a href="#propagating-generated-resources">propagating generated resources</a>,
which is a feature subject for removal soon.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="deploying-accurate"><a class="header" href="#deploying-accurate">Deploying Accurate</a></h1>
<ol>
<li>
<p>(Optional) Prepare cert-manager</p>
<p>Accurate depends on <a href="https://cert-manager.io/">cert-manager</a> to issue TLS certificate for admission webhooks.
If cert-manager is not installed on your cluster, install it as follows:</p>
<pre><code class="language-bash">curl -fsLO https://github.com/jetstack/cert-manager/releases/latest/download/cert-manager.yaml
kubectl apply -f cert-manager.yaml
</code></pre>
</li>
<li>
<p>Setup Accurate Helm repository</p>
<pre><code class="language-bash">helm repo add accurate https://cybozu-go.github.io/accurate/
helm repo update
</code></pre>
</li>
<li>
<p>Configuration Helm chart values</p>
<p>Read <a href="#configurations">Configurations</a> for details.</p>
</li>
<li>
<p>Install the Accurate Helm chart</p>
<pre><code class="language-bash">helm install --create-namespace --namespace accurate accurate accurate/accurate -f values.yaml
</code></pre>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="accurate-helm-chart"><a class="header" href="#accurate-helm-chart">Accurate Helm Chart</a></h1>
<h2 id="how-to-use-accurate-helm-repository"><a class="header" href="#how-to-use-accurate-helm-repository">How to use Accurate Helm repository</a></h2>
<p>You need to add this repository to your Helm repositories:</p>
<pre><code class="language-bash">helm repo add accurate https://cybozu-go.github.io/accurate/
helm repo update
</code></pre>
<h2 id="quick-start"><a class="header" href="#quick-start">Quick start</a></h2>
<h3 id="installing-cert-manager"><a class="header" href="#installing-cert-manager">Installing cert-manager</a></h3>
<pre><code class="language-bash">curl -fsL https://github.com/jetstack/cert-manager/releases/latest/download/cert-manager.yaml | kubectl apply -f -
</code></pre>
<h3 id="installing-customresourcedefinitions-optional"><a class="header" href="#installing-customresourcedefinitions-optional">Installing CustomResourceDefinitions (optional)</a></h3>
<p>Accurate does not use the <a href="https://helm.sh/docs/chart_best_practices/custom_resource_definitions/">official helm method</a> of installing CRD resources.
This is because it makes upgrading CRDs impossible with helm CLI alone.
The helm team explain the limitations of their approach <a href="https://helm.sh/docs/chart_best_practices/custom_resource_definitions/#some-caveats-and-explanations">here</a>.</p>
<p>The Accurate Helm chart default is to install and manage CRDs with Helm and
add annotations preventing Helm from uninstalling the CRD when the Helm release is uninstalled.</p>
<p>The recommended approach is to let helm manage CRDs, but if you want to manage CRDs yourself, now is the time.</p>
<pre><code class="language-bash">kubectl apply -k https://github.com/cybozu-go/accurate//config/crd-only/
</code></pre>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Since the CRDs contain configuration of conversion webhooks, you may have to tweak the webhook settings
if installing the chart using non-standard values.</p>
</blockquote>
<p>If you decided to manage CRDs outside of Helm, make sure you set the <code>crds.enabled</code> Helm value to <code>false</code>.</p>
<h3 id="installing-the-chart"><a class="header" href="#installing-the-chart">Installing the Chart</a></h3>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>This installation method requires cert-manager to be installed beforehand.</p>
</blockquote>
<p>To install the chart with the release name <code>accurate</code> using a dedicated namespace(recommended):</p>
<pre><code class="language-bash">helm install --create-namespace --namespace accurate accurate accurate/accurate
</code></pre>
<p>Specify parameters using <code>--set key=value[,key=value]</code> argument to <code>helm install</code>.</p>
<p>Alternatively a YAML file that specifies the values for the parameters can be provided like this:</p>
<pre><code class="language-bash">helm install --create-namespace --namespace accurate accurate -f values.yaml accurate/accurate
</code></pre>
<h2 id="values"><a class="header" href="#values">Values</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Key</th><th>Type</th><th>Default</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td>controller.additionalRBAC.rules</td><td>list</td><td><code>[]</code></td><td>Specify the RBAC rules to be added to the controller. ClusterRole and ClusterRoleBinding are created with the names <code>{{ release name }}-additional-resources</code>. The rules defined here will be used for the ClusterRole rules.</td></tr>
<tr><td>controller.additionalRBAC.clusterRoles</td><td>list</td><td><code>[]</code></td><td>Specify additional ClusterRoles to be granted to the accurate controller. “admin” is recommended to allow the controller to manage common namespace-scoped resources.</td></tr>
<tr><td>controller.config.annotationKeys</td><td>list</td><td><code>[]</code></td><td>Annotations to be propagated to sub-namespaces. It is also possible to specify a glob pattern that can be interpreted by Go’s “path.Match” func.</td></tr>
<tr><td>controller.config.labelKeys</td><td>list</td><td><code>[]</code></td><td>Labels to be propagated to sub-namespaces. It is also possible to specify a glob pattern that can be interpreted by Go’s “path.Match” func.</td></tr>
<tr><td>controller.config.watches</td><td>list</td><td><code>[{"group":"rbac.authorization.k8s.io","kind":"Role","version":"v1"},{"group":"rbac.authorization.k8s.io","kind":"RoleBinding","version":"v1"},{"kind":"Secret","version":"v1"}]</code></td><td>List of GVK for namespace-scoped resources that can be propagated. Any namespace-scoped resource is allowed.</td></tr>
<tr><td>controller.config.propagateAnnotationKeyExcludes</td><td>list</td><td><code>["*kubernetes.io/*"]</code></td><td>Annotations to exclude when propagating resources. It is also possible to specify a glob pattern that can be interpreted by Go’s “path.Match” func.</td></tr>
<tr><td>controller.config.propagateLabelKeyExcludes</td><td>list</td><td><code>["*kubernetes.io/*"]</code></td><td>Labels to exclude when propagating resources. It is also possible to specify a glob pattern that can be interpreted by Go’s “path.Match” func.</td></tr>
<tr><td>controller.extraArgs</td><td>list</td><td><code>[]</code></td><td>Optional additional arguments.</td></tr>
<tr><td>controller.replicas</td><td>int</td><td><code>2</code></td><td>Specify the number of replicas of the controller Pod.</td></tr>
<tr><td>controller.resources</td><td>object</td><td><code>{"requests":{"cpu":"100m","memory":"20Mi"}}</code></td><td>Specify resources.</td></tr>
<tr><td>controller.terminationGracePeriodSeconds</td><td>int</td><td><code>10</code></td><td>Specify terminationGracePeriodSeconds.</td></tr>
<tr><td>webhook.allowCascadingDeletion</td><td>bool</td><td><code>false</code></td><td>Enable to allow cascading deletion of namespaces. Accurate webhooks will only allow deletion of a namespace with children if this option is enabled.</td></tr>
<tr><td>image.pullPolicy</td><td>string</td><td><code>nil</code></td><td>Accurate image pullPolicy.</td></tr>
<tr><td>image.repository</td><td>string</td><td><code>"ghcr.io/cybozu-go/accurate"</code></td><td>Accurate image repository to use.</td></tr>
<tr><td>image.tag</td><td>string</td><td><code>{{ .Chart.AppVersion }}</code></td><td>Accurate image tag to use.</td></tr>
<tr><td>crds.enabled</td><td>bool</td><td><code>true</code></td><td>Decides if the CRDs should be installed as part of the Helm installation.</td></tr>
<tr><td>crds.keep</td><td>bool</td><td><code>true</code></td><td>Setting this to <code>true</code> will prevent Helm from uninstalling the CRD when the Helm release is uninstalled.</td></tr>
<tr><td>installCRDs</td><td>bool</td><td><code>true</code></td><td>Controls if CRDs are automatically installed and managed as part of your Helm release. Deprecated: Use <code>crds.enabled</code> and <code>crds.keep</code> instead.</td></tr>
</tbody>
</table>
</div>
<h2 id="generate-manifests"><a class="header" href="#generate-manifests">Generate Manifests</a></h2>
<p>You can use the <code>helm template</code> command to render manifests.</p>
<pre><code class="language-bash">helm template --namespace accurate accurate accurate/accurate
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="installing-kubectl-plugin"><a class="header" href="#installing-kubectl-plugin">Installing kubectl plugin</a></h1>
<p><code>kubectl-accurate</code> is a plugin for <code>kubectl</code> to make operations of Accurate easy.</p>
<p>It is strongly recommended to install <code>kubectl-accurate</code> though Accurate can be used without the plugin.</p>
<h2 id="installing-using-krew"><a class="header" href="#installing-using-krew">Installing using Krew</a></h2>
<p><a href="https://krew.sigs.k8s.io/">Krew</a> is the plugin manager for kubectl command-line tool.</p>
<p>See the <a href="https://krew.sigs.k8s.io/docs/user-guide/setup/install/">documentation</a> for how to install Krew.</p>
<pre><code class="language-bash">kubectl krew update
kubectl krew install accurate
</code></pre>
<h2 id="installing-manually"><a class="header" href="#installing-manually">Installing manually</a></h2>
<ol>
<li>
<p>Set <code>OS</code> to the operating system name</p>
<p>OS is one of <code>linux</code>, <code>windows</code>, or <code>darwin</code> (MacOS).</p>
<p>If Go is available, <code>OS</code> can be set automatically as follows:</p>
<pre><code class="language-bash">OS=$(go env GOOS)
</code></pre>
</li>
<li>
<p>Set <code>ARCH</code> to the operating system name</p>
<p>ARCH is one of <code>amd64</code> or <code>arm64</code>.</p>
<p>If Go is available, <code>ARCH</code> can be set automatically as follows:</p>
<pre><code class="language-bash">ARCH=$(go env GOARCH)
</code></pre>
</li>
<li>
<p>Set <code>VERSION</code> to the accurate version</p>
<p>See the Accurate release page: <a href="https://github.com/cybozu-go/accurate/releases">https://github.com/cybozu-go/accurate/releases</a></p>
<pre><code class="language-bash">VERSION=&lt; The version you want to install &gt;
</code></pre>
</li>
<li>
<p>Download the binary and put it in a directory of your <code>PATH</code>.</p>
<p>The following is an example to install the plugin in <code>/usr/local/bin</code>.</p>
<pre><code class="language-bash">curl -L -sS https://github.com/cybozu-go/accurate/releases/download/$(VERSION)/kubectl-accurate_$(VERSION)_$(OS)_$(ARCH).tar.gz \
  | tar xz -C /usr/local/bin kubectl-accurate
</code></pre>
</li>
<li>
<p>Check the installation</p>
<p>Run <code>kubectl accurate -h</code> and see the output looks like:</p>
<pre><code class="language-console">$ kubectl accurate -h
accurate is a subcommand of kubectl to manage Accurate features.

Usage:
  accurate [command]

Available Commands:
  completion  generate the autocompletion script for the specified shell
  help        Help about any command
  list        List namespace trees hierarchically
  namespace   namespace subcommand
  sub         sub-namespace command
  template    template subcommand
...
</code></pre>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="usage"><a class="header" href="#usage">Usage</a></h1>
<p>Accurate can be used imperatively using <code>kubectl</code> or declaratively with YAML manifests.</p>
<p>The following sections will show you the usage in both ways.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="showing-information"><a class="header" href="#showing-information">Showing information</a></h1>
<h2 id="show-the-hierarchical-list-of-sub-namespaces"><a class="header" href="#show-the-hierarchical-list-of-sub-namespaces">Show the hierarchical list of sub-namespaces</a></h2>
<p>Use <code>kubectl accurate list</code>:</p>
<pre><code class="language-console">$ kubectl accurate list
├── root1
├── root2
│   └── sub1
├── root3
├── subroot1
│   └── sn1
└── subroot2
</code></pre>
<h2 id="show-all-template-namespaces"><a class="header" href="#show-all-template-namespaces">Show all template Namespaces</a></h2>
<p>Use <code>kubectl accurate template list</code>:</p>
<pre><code class="language-console">$ kubectl accurate template list
├── template1
├── template2
│   ├── reference1
│   └── reference2
└── template3
</code></pre>
<h2 id="show-the-properties-of-a-namespace"><a class="header" href="#show-the-properties-of-a-namespace">Show the properties of a Namespace</a></h2>
<p>Use <code>kubectl accurate ns describe</code>:</p>
<pre><code class="language-console">$ kubectl accurate ns describe root2
Name: root2
Type: root
# of children: 1

Resources:
Kind     Name     From     Mode
-------- -------- -------- --------
Role     role1    tmpl3    create
Secret   mysecret          create
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="setting-up-templates"><a class="header" href="#setting-up-templates">Setting up templates</a></h1>
<p>Template is a feature of Accurate to propagate labels, annotations, and resources between normal Namespaces.</p>
<p>Any Namespace except for sub-namespaces can reference a template Namespace.
So, a template Namespace can reference another template Namespace.</p>
<p>In the following examples, <code>&lt;name&gt;</code> represents a Namespace name to be changed.
Likewise, <code>&lt;template&gt;</code> represents a template Namespace name.</p>
<h2 id="setting-a-namespace-as-a-template"><a class="header" href="#setting-a-namespace-as-a-template">Setting a Namespace as a template</a></h2>
<p>Using <code>kubectl accurate</code>:</p>
<pre><code class="language-bash">kubectl accurate ns set-type &lt;name&gt; template
</code></pre>
<p>Applying YAML manifests:</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Namespace
metadata:
  name: &lt;name&gt;
  labels:
    accurate.cybozu.com/type: template
</code></pre>
<h2 id="reverting-a-template-namespace-to-a-normal-one"><a class="header" href="#reverting-a-template-namespace-to-a-normal-one">Reverting a template Namespace to a normal one</a></h2>
<p>Using <code>kubectl accurate</code>:</p>
<pre><code class="language-bash">kubectl accurate ns set-type &lt;name&gt; none
</code></pre>
<p>Applying YAML manifests:</p>
<p>Remove <code>accurate.cybozu.com/type</code> label.</p>
<h2 id="setting-a-reference-to-a-template-namespace"><a class="header" href="#setting-a-reference-to-a-template-namespace">Setting a reference to a template Namespace</a></h2>
<p>Using <code>kubectl accurate</code>:</p>
<pre><code class="language-bash">kubectl accurate template set &lt;name&gt; &lt;template&gt;
</code></pre>
<p>Applying YAML manifests:</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Namespace
metadata:
  name: &lt;name&gt;
  labels:
    accurate.cybozu.com/template: &lt;template&gt;
</code></pre>
<h2 id="unsetting-a-reference-to-a-template-namespace"><a class="header" href="#unsetting-a-reference-to-a-template-namespace">Unsetting a reference to a template Namespace</a></h2>
<p>Using <code>kubectl accurate</code>:</p>
<pre><code class="language-bash">kubectl accurate template unset &lt;name&gt;
</code></pre>
<p>Applying YAML manifests:</p>
<p>Remove <code>accurate.cybozu.com/template</code> label.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="propagating-resources"><a class="header" href="#propagating-resources">Propagating resources</a></h1>
<p>Accurate propagates only resources annotated with <code>accurate.cybozu.com/propagate=&lt;mode&gt;</code>.</p>
<p>The Group/Version/Kind of the resource must be listed in the <a href="#configurations">configuration file</a>.</p>
<p>In the following examples, <code>&lt;mode&gt;</code> represents either <code>create</code> or <code>update</code>.
Read <a href="#concepts">Concepts</a> about the propagation modes.</p>
<h2 id="annotating-a-resource-for-propagation"><a class="header" href="#annotating-a-resource-for-propagation">Annotating a resource for propagation</a></h2>
<p>The following is an example to propagate Secrets.</p>
<p>Using <code>kubectl</code>:</p>
<pre><code class="language-bash">kubectl annotate secrets &lt;name&gt; accurate.cybozu.com/propagate=&lt;mode&gt;
</code></pre>
<p>Applying YAML manifests:</p>
<pre><code class="language-console">apiVersion: v1
kind: Secret
metadata:
  namespace: default
  name: &lt;name&gt;
  annotations:
    accurate.cybozu.com/propagate: &lt;mode&gt;
</code></pre>
<h2 id="annotating-a-resource-to-propagate-resources-created-from-it-deprecated"><a class="header" href="#annotating-a-resource-to-propagate-resources-created-from-it-deprecated">Annotating a resource to propagate resources created from it (DEPRECATED)</a></h2>
<div class="warning">
Propagating generated resources is a deprecated feature and is subject for
removal soon. Commonly used tools like cert-manager and sealed-secrets now
provide features for adding annotations/labels to resources created from
user-facing custom resources. These features can be used for migration to
ensure the standard `accurate.cybozu.com/propagate` annotation is added to
generated resources.
</div>

<p>For example, a Secret created from cert-manager’s Certificate can automatically be propagated.</p>
<p>To do this, Certificate should be annotated with <code>accurate.cybozu.com/propagate-generated=&lt;mode&gt;</code> at the time of creation.</p>
<pre><code class="language-yaml">apiVersion: cert-manager.io/v1
kind: Certificate
metadata:
  namespace: default
  name: example-cert
  annotations:
    accurate.cybozu.com/propagate-generated: &lt;mode&gt;
spec:
  ...
</code></pre>
<p><code>accurate-controller</code> needs to be able to get Certificate objects.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="sub-namespace-operations"><a class="header" href="#sub-namespace-operations">Sub-namespace operations</a></h1>
<p>Sub-namespaces is a feature of Accurate to allow tenant users to create Namespaces and delete the created Namespaces.</p>
<p>Sub-namespaces can be created under either a root Namespace or a sub-namespace.</p>
<p>In the following examples, <code>&lt;name&gt;</code> represents a Namespace name to be changed.
Likewise, <code>&lt;parent&gt;</code> represents a root or another sub-namespace.</p>
<h2 id="setting-a-namespace-as-a-root-namespace"><a class="header" href="#setting-a-namespace-as-a-root-namespace">Setting a Namespace as a root Namespace</a></h2>
<p>Suppose that Accurate is configured to propagate <code>team</code> label.</p>
<p>Using <code>kubectl accurate</code>:</p>
<pre><code class="language-bash">kubectl accurate ns set-type &lt;name&gt; root
kubectl label ns &lt;name&gt; team=foo
</code></pre>
<p>Applying YAML manifests:</p>
<pre><code class="language-console">apiVersion: v1
kind: Namespace
metadata:
  name: &lt;name&gt;
  labels:
    accurate.cybozu.com/type: root
    team: foo
</code></pre>
<p>Accurate only propagates labels/annotations that have been configured in that respect via the <code>labelKeys</code> and <code>annotationKeys</code> parameters in <code>config.yaml</code>. This prevents the propagation of labels/annotations that were not meant to do so.</p>
<h3 id="preparing-resources-for-tenant-users"><a class="header" href="#preparing-resources-for-tenant-users">Preparing resources for tenant users</a></h3>
<p>In almost all cases, a root Namespace should have RoleBinding for a group of tenant users.
The RoleBinding should be annotated with <code>accurate.cybozu.com/propagate=update</code>.</p>
<pre><code class="language-yaml">apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  namespace: &lt;name&gt;
  name: admin
  annotations:
    accurate.cybozu.com/propagate: update
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: admin
subjects:
- kind: Group
  name: foo
  apiGroup: rbac.authorization.k8s.io
</code></pre>
<p>You may want to prepare more objects such as ResourceQuotas.</p>
<h2 id="reverting-a-root-namespace-to-a-normal-one"><a class="header" href="#reverting-a-root-namespace-to-a-normal-one">Reverting a root Namespace to a normal one</a></h2>
<p>Using <code>kubectl accurate</code>:</p>
<pre><code class="language-bash">kubectl accurate ns set-type &lt;name&gt; none
</code></pre>
<p>Applying YAML manifests:</p>
<p>Remove <code>accurate.cybozu.com/type</code> label.</p>
<h2 id="creating-a-sub-namespace"><a class="header" href="#creating-a-sub-namespace">Creating a sub-namespace</a></h2>
<p>Using <code>kubectl accurate</code>:</p>
<pre><code class="language-bash">kubectl accurate sub create &lt;name&gt; &lt;parent&gt;
</code></pre>
<p>Applying YAML manifests:</p>
<pre><code class="language-console">apiVersion: accurate.cybozu.com/v2
kind: SubNamespace
metadata:
  namespace: &lt;parent&gt;
  name: &lt;name&gt;
</code></pre>
<h3 id="creating-a-sub-namespace-with-additional-labelsannotations"><a class="header" href="#creating-a-sub-namespace-with-additional-labelsannotations">Creating a sub-namespace with additional labels/annotations</a></h3>
<p>Using <code>kubectl accurate</code>:</p>
<pre><code class="language-bash">kubectl accurate sub create &lt;name&gt; &lt;parent&gt; --labels=foo=bar --annotations=baz=zot
</code></pre>
<p>Applying YAML manifests:</p>
<pre><code class="language-yaml">apiVersion: accurate.cybozu.com/v2
kind: SubNamespace
metadata:
  namespace: &lt;parent&gt;
  name: &lt;name&gt;
spec:
  labels:
    foo: bar
  annotations:
    baz: zot
</code></pre>
<p>You can edit these <code>spec.labels/spec.annotations</code> with <code>kubectl edit</code>:</p>
<pre><code class="language-bash">kubectl edit SubNamespace -n=&lt;parent&gt; &lt;name&gt;
</code></pre>
<p>The <code>spec.labels/spec.annotations</code> that can be propagated to sub-namespaces can be set with the <code>subNamespaceLabelKeys/subNamespaceAnnotationKeys</code> parameters in config.yaml.</p>
<h2 id="deleting-a-created-sub-namespace"><a class="header" href="#deleting-a-created-sub-namespace">Deleting a created sub-namespace</a></h2>
<p>Using <code>kubectl accurate</code>:</p>
<pre><code class="language-bash">kubectl accurate sub delete &lt;name&gt;
</code></pre>
<p>Applying YAML manifests:</p>
<p>Delete the created SubNamespace object.</p>
<h2 id="changing-the-parent-of-a-sub-namespace"><a class="header" href="#changing-the-parent-of-a-sub-namespace">Changing the parent of a sub-namespace</a></h2>
<p>Only cluster admins can do this.</p>
<p>Using <code>kubectl accurate</code>:</p>
<pre><code class="language-bash">kubectl accurate sub move &lt;name&gt; &lt;new-parent&gt;
</code></pre>
<p>Applying YAML manifests:</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Namespace
metadata:
  name: &lt;name&gt;
  labels:
    accurate.cybozu.com/parent: &lt;new-parent&gt;
</code></pre>
<h2 id="converting-a-normal-namespace-to-a-sub-namespace"><a class="header" href="#converting-a-normal-namespace-to-a-sub-namespace">Converting a normal Namespace to a sub-namespace</a></h2>
<p>Only cluster admins can do this.</p>
<p>Using <code>kubectl accurate</code>:</p>
<pre><code class="language-bash">kubectl accurate sub graft &lt;name&gt; &lt;parent&gt;
</code></pre>
<p>Applying YAML manifests:</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Namespace
metadata:
  name: &lt;name&gt;
  labels:
    accurate.cybozu.com/parent: &lt;parent&gt;
</code></pre>
<h2 id="converting-a-sub-namespace-to-a-root-namespace"><a class="header" href="#converting-a-sub-namespace-to-a-root-namespace">Converting a sub-namespace to a root Namespace</a></h2>
<p>Only cluster admins can do this.</p>
<p>Using <code>kubectl accurate</code>:</p>
<pre><code class="language-bash">kubectl accurate sub cut &lt;name&gt;
</code></pre>
<p>Applying YAML manifests:</p>
<pre><code class="language-yaml">apiVersion: v1
kind: Namespace
metadata:
  name: &lt;name&gt;
  labels:
    accurate.cybozu.com/type: root
    # and remove accurate.cybozu.com/parent label
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="subnamespace-custom-resource-1"><a href="#subnamespace-custom-resource-1" class="header">SubNamespace custom resource</a></h1>
<h3 id="custom-resources"><a class="header" href="#custom-resources">Custom Resources</a></h3>
<ul>
<li><a href="#subnamespace">SubNamespace</a></li>
</ul>
<h3 id="sub-resources"><a class="header" href="#sub-resources">Sub Resources</a></h3>
<ul>
<li><a href="#subnamespacelist">SubNamespaceList</a></li>
<li><a href="#subnamespacespec">SubNamespaceSpec</a></li>
</ul>
<h4 id="subnamespace"><a class="header" href="#subnamespace">SubNamespace</a></h4>
<p>SubNamespace is the Schema for the subnamespaces API Deprecated: This type will be removed in one of the next releases.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Field</th><th>Description</th><th>Scheme</th><th>Required</th></tr>
</thead>
<tbody>
<tr><td>metadata</td><td></td><td>metav1.ObjectMeta</td><td>false</td></tr>
<tr><td>spec</td><td>Spec is the spec of SubNamespace.</td><td><a href="#subnamespacespec">SubNamespaceSpec</a></td><td>false</td></tr>
<tr><td>status</td><td>Status is the status of SubNamespace.</td><td>SubNamespaceStatus</td><td>false</td></tr>
</tbody>
</table>
</div>
<p><a href="#custom-resources">Back to Custom Resources</a></p>
<h4 id="subnamespacelist"><a class="header" href="#subnamespacelist">SubNamespaceList</a></h4>
<p>SubNamespaceList contains a list of SubNamespace Deprecated: This type will be removed in one of the next releases.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Field</th><th>Description</th><th>Scheme</th><th>Required</th></tr>
</thead>
<tbody>
<tr><td>metadata</td><td></td><td>metav1.ListMeta</td><td>false</td></tr>
<tr><td>items</td><td></td><td>[]<a href="#subnamespace">SubNamespace</a></td><td>true</td></tr>
</tbody>
</table>
</div>
<p><a href="#custom-resources">Back to Custom Resources</a></p>
<h4 id="subnamespacespec"><a class="header" href="#subnamespacespec">SubNamespaceSpec</a></h4>
<p>SubNamespaceSpec defines the desired state of SubNamespace</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Field</th><th>Description</th><th>Scheme</th><th>Required</th></tr>
</thead>
<tbody>
<tr><td>labels</td><td>Labels are the labels to be propagated to the sub-namespace</td><td>map[string]string</td><td>false</td></tr>
<tr><td>annotations</td><td>Annotations are the annotations to be propagated to the sub-namespace.</td><td>map[string]string</td><td>false</td></tr>
</tbody>
</table>
</div>
<p><a href="#custom-resources">Back to Custom Resources</a></p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="commands"><a class="header" href="#commands">Commands</a></h1>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="kubectl-accurate"><a class="header" href="#kubectl-accurate">kubectl-accurate</a></h1>
<p><code>kubectl-accurate</code> is a <code>kubectl</code> plugin for Accurate.</p>
<h2 id="features-1"><a class="header" href="#features-1">Features</a></h2>
<ul>
<li>Hierarchical view of namespace trees</li>
<li>Show the information about a namespace.
<ul>
<li>List of propagating/propagated resources in the namespace.</li>
<li>Root or not.</li>
<li>Template or not.</li>
<li>The parent namespace, if it is a sub-namespace.</li>
<li>The template namespace, if set.</li>
</ul>
</li>
<li>Operations for root namespaces
<ul>
<li>Make an independent namespace to a root namespace.</li>
<li>Make a root namespace back to an independent namespace, if it has no child sub-namespaces.</li>
</ul>
</li>
<li>Operations for setting a template namespace</li>
<li>Operations for sub-namespaces
<ul>
<li>Create a sub-namespace under a root namespace or another sub-namespace.</li>
<li>Deleting a sub-namespace.</li>
<li>Move a sub-namespace under a different root or sub-namespace.</li>
<li>Convert an independent namespace to a sub-namespace.</li>
<li>Convert a sub-namespace to a root namespace.</li>
</ul>
</li>
</ul>
<h2 id="generic-options"><a class="header" href="#generic-options">Generic options</a></h2>
<p><code>kubectl-accurate</code> takes the same generic options as <code>kubectl</code> including:</p>
<pre><code class="language-txt">Flags:
      --as string                      Username to impersonate for the operation
      --as-group stringArray           Group to impersonate for the operation, this flag can be repeated to specify multiple groups.
      --cache-dir string               Default cache directory (default "$HOME/.kube/cache")
      --certificate-authority string   Path to a cert file for the certificate authority
      --client-certificate string      Path to a client certificate file for TLS
      --client-key string              Path to a client key file for TLS
      --cluster string                 The name of the kubeconfig cluster to use
      --context string                 The name of the kubeconfig context to use
      --insecure-skip-tls-verify       If true, the server's certificate will not be checked for validity. This will make your HTTPS connections insecure
      --kubeconfig string              Path to the kubeconfig file to use for CLI requests.
  -n, --namespace string               If present, the namespace scope for this CLI request
      --request-timeout string         The length of time to wait before giving up on a single server request. Non-zero values should contain a corresponding time unit (e.g. 1s, 2m, 3h). A value of zero means don't timeout requests. (default "0")
  -s, --server string                  The address and port of the Kubernetes API server
      --tls-server-name string         Server name to use for server certificate validation. If it is not provided, the hostname used to contact the server is used
      --token string                   Bearer token for authentication to the API server
      --user string                    The name of the kubeconfig user to use
</code></pre>
<p>Note that <code>kubectl-accurate</code> does <em>not</em> use the namespace given by <code>-n</code> / <code>--namespace</code> flag.
It always take namespace names as positional arguments.</p>
<h2 id="commands-1"><a class="header" href="#commands-1">Commands</a></h2>
<p>There is an alias for <code>namespace</code> sub-command that is <code>ns</code>.</p>
<h3 id="list-root"><a class="header" href="#list-root"><code>list [ROOT]</code></a></h3>
<p>List namespace trees hierarchically.
If <code>ROOT</code> is given, only the tree starting from <code>ROOT</code> namespace is shown.</p>
<h3 id="namespace-describe-ns"><a class="header" href="#namespace-describe-ns"><code>namespace describe NS</code></a></h3>
<p>Describe the information about a namespace <code>NS</code> related to Accurate.</p>
<h3 id="namespace-set-type-ns-type"><a class="header" href="#namespace-set-type-ns-type"><code>namespace set-type NS TYPE</code></a></h3>
<p>Set the type of a namespace <code>NS</code> to <code>TYPE</code>.</p>
<p>Valid types are <code>root</code> or <code>template</code>.</p>
<p>To unset the type, specify <code>none</code> as the type.</p>
<h3 id="template-list-template"><a class="header" href="#template-list-template"><code>template list [TEMPLATE]</code></a></h3>
<p>List template namespace trees hierarchically.
If TEMPLATE is not given, all template namespaces are shown hierarchically.
If TEMPLATE is given, only the tree under the TEMPLATE namespace will be shown.</p>
<h3 id="template-set-ns-template"><a class="header" href="#template-set-ns-template"><code>template set NS TEMPLATE</code></a></h3>
<p>Set <code>TEMPLATE</code> namespace as the template of <code>NS</code> namespace.</p>
<h3 id="template-unset-ns"><a class="header" href="#template-unset-ns"><code>template unset NS</code></a></h3>
<p>Unset the template of <code>NS</code> namespace.</p>
<h3 id="sub-create-name-ns"><a class="header" href="#sub-create-name-ns"><code>sub create NAME NS</code></a></h3>
<p>Create a <a href="#subnamespace-custom-resource-1">SubNamespace</a> named <code>NAME</code> in <code>NS</code> namespace.</p>
<p>After that, Accurate will create a namespace <code>NAME</code> as a sub-namespace of <code>NS</code>.</p>
<h3 id="sub-delete-name"><a class="header" href="#sub-delete-name"><code>sub delete NAME</code></a></h3>
<p>Delete a <a href="#subnamespace-custom-resource-1">SubNamespace</a> named <code>NAME</code> in the parent namespace of <code>NAME</code> namespace.</p>
<p>After that, Accurate will delete <code>NAME</code> namespace.</p>
<h3 id="sub-move-ns-parent"><a class="header" href="#sub-move-ns-parent"><code>sub move NS PARENT</code></a></h3>
<p>Move a sub-namespace <code>NS</code> to a different root or sub-namespace.</p>
<p>After that, Accurate will create <a href="#subnamespace-custom-resource-1">SubNamespace</a> object in the new parent namespace.</p>
<h3 id="sub-graft-ns-parent"><a class="header" href="#sub-graft-ns-parent"><code>sub graft NS PARENT</code></a></h3>
<p>Like <code>sub move</code>, but this converts a non-sub-namespace <code>NS</code> to a sub-namespace of <code>PARENT</code>.</p>
<p><code>NS</code> must not be a root namespace or have a template.</p>
<h3 id="sub-cut-ns"><a class="header" href="#sub-cut-ns"><code>sub cut NS</code></a></h3>
<p>Make a sub-namespace <code>NS</code> a new root namespace.
The child sub-namespaces under <code>NS</code> will be moved along with it.</p>
<p>Propagated resources with mode <code>update</code> in <code>NS</code> will be deleted.</p>
<h3 id="sub-list-root"><a class="header" href="#sub-list-root"><code>sub list [ROOT]</code></a></h3>
<p>Alias for <code>kubectl-accurate list</code> command.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="accurate-controller"><a class="header" href="#accurate-controller">accurate-controller</a></h1>
<p><code>accurate-controller</code> is a Kubernetes controller to manage sub-namespaces and
to propagate resources from parents to their children namespaces.</p>
<h2 id="configuration-file-1"><a class="header" href="#configuration-file-1">Configuration file</a></h2>
<p><code>accurate-controller</code> reads a configuration file on startup.
The default location is <code>/etc/accurate/config.yaml</code>.
The location can be changed with <code>--config-file</code> flag.</p>
<p>The configuration file should be a JSON or YAML file having the following keys:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Key</th><th>Type</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>labelKeys</code></td><td><code>[]string</code></td><td>Keys of namespace labels to be propagated.</td></tr>
<tr><td><code>annotationKeys</code></td><td><code>[]string</code></td><td>Keys of namespace annotations to be propagated.</td></tr>
<tr><td><code>subNamespaceLabelKeys</code></td><td><code>[]string</code></td><td>Keys of SubNamespace labels to be propagated.</td></tr>
<tr><td><code>subNamespaceAnnotationKeys</code></td><td><code>[]string</code></td><td>Keys of SubNamespace annotations to be propagated.</td></tr>
<tr><td><code>watches</code></td><td><code>[]object</code></td><td>GroupVersionKind of namespace-scoped objects to be propagated.</td></tr>
</tbody>
</table>
</div>
<p>Example:</p>
<pre><code class="language-yaml">labelKeys:
- team

annotationKeys:
- foo.bar/baz

subNamespaceLabelKeys:
- app

subNamespaceAnnotationKeys:
- foo.bar/baz

watches:
- group: rbac.authorization.k8s.io
  version: v1
  kind: Role
- group: rbac.authorization.k8s.io
  version: v1
  kind: RoleBinding
- version: v1
  kind: Secret
</code></pre>
<h2 id="environment-variables"><a class="header" href="#environment-variables">Environment variables</a></h2>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Name</th><th>Required</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>POD_NAMESPACE</code></td><td>Yes</td><td>The namespace name where <code>accurate-controller</code> is running.</td></tr>
</tbody>
</table>
</div>
<h2 id="command-line-flags"><a class="header" href="#command-line-flags">Command-line flags</a></h2>
<pre><code class="language-txt">Flags:
      --add_dir_header                   If true, adds the file directory to the header
      --alsologtostderr                  log to standard error as well as files
      --apiserver-qps-throttle int       The maximum QPS to the API server. (default 50)
      --cert-dir string                  webhook certificate directory
      --config-file string               Configuration file path (default "/etc/accurate/config.yaml")
      --health-probe-addr string         Listen address for health probes (default ":8081")
  -h, --help                             help for accurate-controller
      --leader-election-id string        ID for leader election by controller-runtime (default "accurate")
      --log_backtrace_at traceLocation   when logging hits line file:N, emit a stack trace (default :0)
      --log_dir string                   If non-empty, write log files in this directory
      --log_file string                  If non-empty, use this log file
      --log_file_max_size uint           Defines the maximum size a log file can grow to. Unit is megabytes. If the value is 0, the maximum file size is unlimited. (default 1800)
      --logtostderr                      log to standard error instead of files (default true)
      --metrics-addr string              The address the metric endpoint binds to (default ":8080")
      --skip_headers                     If true, avoid header prefixes in the log messages
      --skip_log_headers                 If true, avoid headers when opening log files
      --stderrthreshold severity         logs at or above this threshold go to stderr (default 2)
  -v, --v Level                          number for the log level verbosity
      --version                          version for accurate-controller
      --vmodule moduleSpec               comma-separated list of pattern=N settings for file-filtered logging
      --webhook-addr string              Listen address for the webhook endpoint (default ":9443")
      --zap-devel                        Development Mode defaults(encoder=consoleEncoder,logLevel=Debug,stackTraceLevel=Warn). Production Mode defaults(encoder=jsonEncoder,logLevel=Info,stackTraceLevel=Error)
      --zap-encoder encoder              Zap log encoding (one of 'json' or 'console')
      --zap-log-level level              Zap Level to configure the verbosity of logging. Can be one of 'debug', 'info', 'error', or any integer value &gt; 0 which corresponds to custom debug levels of increasing verbosity
      --zap-stacktrace-level level       Zap Level at and above which stacktraces are captured (one of 'info', 'error', 'panic').
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="labels-used-by-accurate"><a class="header" href="#labels-used-by-accurate">Labels used by Accurate</a></h1>
<p>The table below is a list of labels used by Accurate.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Key</th><th>Value</th><th>Resource</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>accurate.cybozu.com/type</code></td><td><code>template</code> or <code>root</code></td><td>Namespace</td><td>The type of namespace.</td></tr>
<tr><td><code>accurate.cybozu.com/template</code></td><td>Namespace name</td><td>Namespace</td><td>The template namespace name.</td></tr>
<tr><td><code>accurate.cybozu.com/parent</code></td><td>Namespace name</td><td>Namespace</td><td>The parent namespace name.</td></tr>
<tr><td><code>app.kubernetes.io/created-by</code></td><td><code>accurate</code></td><td>Copied or propagated resources, sub-namespaces</td><td>Informational</td></tr>
</tbody>
</table>
</div>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="annotations-used-by-accurate"><a class="header" href="#annotations-used-by-accurate">Annotations used by Accurate</a></h1>
<p>The table below is a list of annotations used by Accurate.</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Key</th><th>Value</th><th>Resource</th><th>Description</th></tr>
</thead>
<tbody>
<tr><td><code>accurate.cybozu.com/from</code></td><td>Namespace name</td><td>Copied or propagated resources</td><td>The namespace name from which the source resource was copied.</td></tr>
<tr><td><code>accurate.cybozu.com/propagate</code></td><td><code>"create"</code> or <code>"update"</code></td><td>Namespace-scoped resources</td><td>Specify propagation mode.</td></tr>
<tr><td><code>accurate.cybozu.com/propagate-generated</code> ⚠️</td><td><code>"create"</code> or <code>"update"</code></td><td>Namespace-scoped resources</td><td><code>DEPRECATED</code> Specify propagation mode of generated resources.</td></tr>
<tr><td><code>accurate.cybozu.com/generated</code> ⚠️</td><td><code>false</code></td><td>Namespace-scoped resources</td><td><code>DEPRECATED</code> The result of checking if this is generated from another resource.</td></tr>
</tbody>
</table>
</div>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="design-notes"><a class="header" href="#design-notes">Design notes</a></h1>
<ul>
<li><a href="#overview-1">Overview</a></li>
<li><a href="#why-do-we-need-another-namespace-controller-in-the-first-place">Why do we need another namespace controller in the first place?</a></li>
<li><a href="#goals">Goals</a></li>
<li><a href="#things-to-be-avoided">Things to be avoided</a>
<ul>
<li><a href="#no-webhooks-for-propagated-resources">No webhooks for propagated resources</a></li>
</ul>
</li>
<li><a href="#subnamespaces-are-not-related-to-parent-child-relationships">SubNamespaces are not related to parent-child relationships</a></li>
</ul>
<h2 id="overview-1"><a class="header" href="#overview-1">Overview</a></h2>
<p>Accurate aims to implement functionalities found in <a href="https://github.com/kubernetes-sigs/hierarchical-namespaces">Hierarchical Namespace Controller (HNC)</a>, but in a different way.</p>
<p>Accurate provides 1) resource-propagation between namespaces, and 2) sub-namespace concept for multi-tenancy.
Since we consider resource-propagation alone is highly useful, the feature is available between any namespaces.</p>
<h2 id="why-do-we-need-another-namespace-controller-in-the-first-place"><a class="header" href="#why-do-we-need-another-namespace-controller-in-the-first-place">Why do we need another namespace controller in the first place?</a></h2>
<p>Some of the HNC designs and specifications contradict our use cases.</p>
<ul>
<li>HNC opt-outs resources when propagating them.
<ul>
<li>For safety and accuracy, we need opt-in propagation.</li>
</ul>
</li>
<li>HNC opt-outs root namespaces.
<ul>
<li>For easier-maintenance, we need opt-in root namespaces.</li>
</ul>
</li>
<li>HNC does not propagate namespace labels and annotations.
<ul>
<li>We need to propagate some namespace labels/annotations.</li>
</ul>
</li>
</ul>
<p>Since these are fundamentally different requirements, we decided to develop our own solution.</p>
<h2 id="goals"><a class="header" href="#goals">Goals</a></h2>
<ul>
<li>Any namespace-scoped resource can be copied or propagated
<ul>
<li>The kinds of resources are given by the configuration file of Accurate.</li>
<li>Only resources annotated with <code>accurate.cybozu.com/propagate: &lt;mode&gt;</code> will be propagated.</li>
<li>Of course, Accurate controller needs to be privileged to manage them.</li>
</ul>
</li>
<li>Support the following propagation modes:
<ul>
<li><code>create</code>: if the resource does not exist, copy the resource from the parent namespace.</li>
<li><code>update</code>: if the resource is missing or different from the parent namespace, create or update it.  If the parent resource is deleted, the copy will also be deleted.</li>
</ul>
</li>
<li>⚠️ Propagate generated resources (DEPRECATED)
<ul>
<li>Resources created and controlled by another resource can be automatically propagated.</li>
<li>The generator resource should be annotated with <code>accurate.cybozu.com/propagate-generated: &lt;mode&gt;</code>.</li>
</ul>
</li>
<li>Propagate labels and annotations of parent or template namespaces
<ul>
<li>The label/annotation keys are given through the configuration file of Accurate.</li>
<li>Only labels/annotations specified in the configuration file of Accurate will be propagated.</li>
<li>Label/annotation deletions from parent or template namespaces will not be propagated.</li>
</ul>
</li>
<li>Opt-in root namespaces
<ul>
<li>Only namespaces labeled with <code>accurate.cybozu.com/type: root</code> can be the root of a namespace tree.</li>
</ul>
</li>
<li>Tenant users can create and delete sub-namespaces by creating and deleting a custom resource in a root or a sub-namespace.
<ul>
<li>If a namespace has one or more sub-namespaces, Accurate prevents the deletion of the namespace - unless allow cascading deletion of namespaces is enabled.</li>
</ul>
</li>
<li>Template namespace
<ul>
<li>Namespaces that are not a sub-namespace can specify a template from which labels, annotations, and resources can be propagated.</li>
</ul>
</li>
<li>Admins can change the parent namespace of a sub-namespace.</li>
</ul>
<h2 id="things-to-be-avoided"><a class="header" href="#things-to-be-avoided">Things to be avoided</a></h2>
<p>Accurate prevents the following problems by a validating admission webhook for Namespace.</p>
<ul>
<li>Circular references among namespaces.</li>
<li>Allowing a sub-namespace to set a template (sub-namespaces should inherit things only from the parent).</li>
<li>Marking a sub-namespace as a root namespace.</li>
<li>Deleting <code>accurate.cybozu.com/type=root</code> label from root namespaces having one or more sub-namespaces.</li>
<li>Deleting <code>accurate.cybozu.com/type=template</code> label from template namespaces having one or more instance namespaces.</li>
<li>Dangling sub-namespaces (sub-namespaces whose parent namespace is missing).</li>
<li>Dangling instance namespaces (namespaces whose template namespace is missing).</li>
<li>Changing a sub-namespace to a non-root namespace when it has child sub-namespaces.</li>
</ul>
<p>Accurate prevents the following problem by a validating admission webhook for SubNamespace.</p>
<ul>
<li>Creating a SubNamespace object in a non-root and non-sub- namespace.</li>
</ul>
<h3 id="no-webhooks-for-propagated-resources"><a class="header" href="#no-webhooks-for-propagated-resources">No webhooks for propagated resources</a></h3>
<p>Accurate does not use admission webhooks for resources propagated from a parent namespace to its sub-namespaces.
The decision was made from the following points:</p>
<ul>
<li>
<p>Since Accurate can propagate any namespace-scoped resource, adding an admission webhook for them might cause troubles.</p>
<p>For instance, admission webhooks for Pods may cause chicken-and-egg problem upon bootstrapping.</p>
</li>
<li>
<p>Avoid interrupting users who do not expect limitations from Accurate.</p>
</li>
</ul>
<h2 id="subnamespaces-are-not-related-to-parent-child-relationships"><a class="header" href="#subnamespaces-are-not-related-to-parent-child-relationships">SubNamespaces are not related to parent-child relationships</a></h2>
<p>Accurate does not rely on SubNamespace resources to look up sub-namespaces of a namespace or to find the parent of a sub-namespace.</p>
<p>By doing so, Accurate can easily restructure existing namespaces.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="how-accurate-reconciles-resources"><a class="header" href="#how-accurate-reconciles-resources">How Accurate reconciles resources</a></h1>
<p>Accurate primarily watches Namespaces and SubNamespaces.
In addition, it needs to watch any kind of resources specified in its config file.</p>
<h2 id="subnamespace-custom-resource"><a class="header" href="#subnamespace-custom-resource">SubNamespace (custom resource)</a></h2>
<ul>
<li>For a new SubNamespace, Accurate creates a sub-namespace.</li>
<li>For a deleting SubNamespace, Accurate deletes the sub-namespace if the sub-namespace exists and its <code>accurate.cybozu.com/parent</code> is the same as <code>metadata.namespace</code> of SubNamespace.</li>
</ul>
<h2 id="namespaces"><a class="header" href="#namespaces">Namespaces</a></h2>
<h3 id="namespaces-that-are-labeled-with-accuratecybozucomtemplate"><a class="header" href="#namespaces-that-are-labeled-with-accuratecybozucomtemplate">Namespaces that are labeled with <code>accurate.cybozu.com/template</code></a></h3>
<p>These namespaces reference a template namespace and propagate the labels, annotations, and watched resources from the template namespace.</p>
<ul>
<li>Accurate should propagate labels and/or annotations from the template namespace.</li>
<li>Accurate should create copies of resources in the template namespace whose <code>accurate.cybozu.com/propagate</code> annotation is <code>create</code> if they are missing.</li>
<li>Accurate should create or update copies of resources in the template namespace whose <code>accurate.cybozu.com/propagate</code> annotation is <code>update</code> if they are missing or different.</li>
<li>Accurate should delete resources in the reconciling namespace that are annotated with <code>accurate.cybozu.com/propagate=update</code> provided that:
<ul>
<li>the value of <code>accurate.cybozu.com/from</code> annotation is not the template namespace name, or</li>
<li>there is not a resource of the same kind and the same name in the template namespace.</li>
</ul>
</li>
</ul>
<h3 id="namespaces-wo-accuratecybozucomtype-and-accuratecybozucomtemplate-labels"><a class="header" href="#namespaces-wo-accuratecybozucomtype-and-accuratecybozucomtemplate-labels">Namespaces w/o <code>accurate.cybozu.com/type</code> and <code>accurate.cybozu.com/template</code> labels</a></h3>
<p>If these labels are removed from the Namespace, Accurate should delete propagated resources with mode == <code>update</code>.</p>
<h3 id="template-namespace"><a class="header" href="#template-namespace">Template namespace</a></h3>
<p>Template namespaces are namespaces labeled with <code>accurate.cybozu.com/type=template</code>.</p>
<ul>
<li>Accurate should propagate labels and/or annotations to namespaces that references the template namespace with <code>accurate.cybozu.com/template</code> label.</li>
</ul>
<h3 id="root-namespace"><a class="header" href="#root-namespace">Root namespace</a></h3>
<p>Root namespaces are namespaces labeled with <code>accurate.cybozu.com/type=root</code>.</p>
<ul>
<li>Accurate should propagate labels and/or annotations to its sub-namespaces.</li>
</ul>
<h3 id="sub-namespace"><a class="header" href="#sub-namespace">Sub-namespace</a></h3>
<p>Sub-namespaces are namespaces created by Accurate.
Sub-namespaces have <code>accurate.cybozu.com/parent</code> label.</p>
<ul>
<li>Accurate should propagate labels and/or annotations from the parent namespace.</li>
<li>Accurate should propagate labels and/or annotations of the reconciling namespace to its sub-namespaces, if any.</li>
<li>Accurate should create copies of resources in the parent namespace whose <code>accurate.cybozu.com/propagate</code> annotation is <code>create</code> if they are missing.</li>
<li>Accurate should create or update copies of resources in the parent namespace whose <code>accurate.cybozu.com/propagate</code> annotation is <code>update</code> if they are missing or different.</li>
<li>Accurate should delete resources in the reconciling namespace that are annotated with <code>accurate.cybozu.com/propagate=update</code> provided that:
<ul>
<li>the value of <code>accurate.cybozu.com/from</code> annotation is not the parent namespace name, or</li>
<li>there is not a resource of the same kind and the same name in the parent namespace.</li>
</ul>
</li>
</ul>
<h2 id="watched-namespace-scoped-resources"><a class="header" href="#watched-namespace-scoped-resources">Watched namespace-scoped resources</a></h2>
<p>Any namespace-scoped resource can be propagated from a template or from a parent namespace.</p>
<h3 id="resources-annotated-with-accuratecybozucomfrom"><a class="header" href="#resources-annotated-with-accuratecybozucomfrom">Resources annotated with <code>accurate.cybozu.com/from</code></a></h3>
<p>These resources are propagated from a parent or a template namespace.
The annotation value is the parent namespace name.</p>
<ul>
<li>If the parent resource exists and is annotated with <code>accurate.cybozu.com/propagate=update</code>, Accurate compares the resource with the parent resource, and if they differ, updates the resource.</li>
<li>If the resource is annotated with <code>accurate.cybozu.com/propagate=update</code> and there isn’t a resource of the same kind and the same name in the parent namespace, Accurate deletes the resource.</li>
</ul>
<p>The last rule is for cases where the parent resource is deleted while the controller is stopped.
With this rule, Accurate can delete such orphaned resources when the controller starts.</p>
<h3 id="resources-annotated-with-accuratecybozucompropagate"><a class="header" href="#resources-annotated-with-accuratecybozucompropagate">Resources annotated with <code>accurate.cybozu.com/propagate</code></a></h3>
<p>These resources can be propagated to other namespaces.</p>
<ul>
<li>If the resource exists and the annotation value is <code>create</code>, Accurate creates a copy in all sub-namespaces if missing.</li>
<li>If the resource exists and the annotation value is <code>update</code>, Accurate creates or updates a copy in all sub-namespaces if missing or different.</li>
<li>When a resource is deleted, Accurate checks sub-namespaces and delete the resource of the same kind and the same name if the resource is annotated with <code>accurate.cybozu.com/propagate=update</code>.</li>
</ul>
<h3 id="resources-owned-by-another-resource-that-is-annotated-with-accuratecybozucompropagate-generated-deprecated"><a class="header" href="#resources-owned-by-another-resource-that-is-annotated-with-accuratecybozucompropagate-generated-deprecated">Resources owned by another resource that is annotated with <code>accurate.cybozu.com/propagate-generated</code> (DEPRECATED)</a></h3>
<p>Accurate annotates the resource with <code>accurate.cybozu.com/propagate</code>.
The annotation value is the same as <code>accurate.cybozu.com/propagate-generated</code> annotation.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="release-procedure"><a class="header" href="#release-procedure">Release procedure</a></h1>
<p>This document describes how to release a new version.</p>
<h2 id="labeling"><a class="header" href="#labeling">Labeling</a></h2>
<p>Release notes are automatically generated based on PRs included in the release.
Those PRs are categorized based on the label assigned to them.
Please refer to <code>.github/release.yml</code> for the kind of labels.</p>
<h2 id="versioning"><a class="header" href="#versioning">Versioning</a></h2>
<p>Follow <a href="https://semver.org/spec/v2.0.0.html">semantic versioning 2.0.0</a> to choose the new version number.</p>
<h2 id="bump-version"><a class="header" href="#bump-version">Bump version</a></h2>
<ol>
<li>
<p>Determine a new version number. Then set <code>VERSION</code> variable.</p>
<pre><code class="language-bash"># Set VERSION and confirm it. It should not have "v" prefix.
VERSION=x.y.z
echo $VERSION
</code></pre>
</li>
<li>
<p>Add a git tag to the main HEAD, then push it.</p>
<pre><code class="language-bash">git checkout main
git pull
git tag -a -m "Release v$VERSION" "v$VERSION"
git tag -ln | grep $VERSION
git push origin v$VERSION
</code></pre>
</li>
</ol>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="maintenance"><a class="header" href="#maintenance">Maintenance</a></h1>
<h2 id="how-to-update-supported-kubernetes"><a class="header" href="#how-to-update-supported-kubernetes">How to update supported Kubernetes</a></h2>
<p>Accurate supports the three latest Kubernetes versions.
If a new Kubernetes is released, please update the following files.</p>
<ul>
<li>Update Kubernetes version in <code>e2e/Makefile</code> and <code>.github/workflows/ci.yaml</code>.</li>
<li>Update kubectl version in <code>aqua.yaml</code>.</li>
<li>Update <code>k8s.io/*</code> and <code>sigs.k8s.io/controller-runtime</code> packages version in <code>go.mod</code>.</li>
</ul>
<p>If Kubernetes or controller-runtime API has changed, please fix the relevant source code.</p>
<h2 id="how-to-update-dependencies"><a class="header" href="#how-to-update-dependencies">How to update dependencies</a></h2>
<p>Renovate will create PRs that update dependencies once a week.
However, Kubernetes is only updated with patched versions.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
